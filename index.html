<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Agenda CCB Amambai/MS</title>

  <!-- OneSignal Web SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "REPLACE_WITH_YOUR_ONESIGNAL_APP_ID",
        notifyButton: { enable: false }
      });
    });
  </script>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2C7A5A">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7f8;color:#122}
    header{padding:18px 16px;background:#2C7A5A;color:#fff}
    main{padding:16px;max-width:900px;margin:0 auto}
    .card{background:#fff;border-radius:14px;padding:14px 14px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .muted{color:#556}
    .pill{display:inline-block;background:#eef7f2;color:#1E5F43;padding:4px 10px;border-radius:999px;font-size:12px;margin-left:8px}
    .btn{display:inline-block;border:0;border-radius:12px;padding:10px 12px;background:#162B32;color:#fff;text-decoration:none;cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .warn{background:#fff6da;border:1px solid #ffe08a}
    code{background:#f0f2f4;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div>
      <div style="font-size:18px;font-weight:800">Agenda CCB Amambai/MS</div>
      <div style="opacity:.9">Push automático via OneSignal (4h e 1h antes)</div>
    </div>
    <div style="margin-left:auto" class="row">
      <button id="btnPerm" class="btn">Ativar notificações</button>
    </div>
  </div>
</header>

<main>
  <div class="card warn">
    <b>✅ Modo Automático Total</b><br>
    Este painel <b>não envia</b> notificações manualmente. O envio é feito automaticamente por um agendador (GitHub Actions) usando sua agenda em <code>agenda.json</code>.
  </div>

  <div class="card">
    <div class="row">
      <div><b>Próximos cultos</b><span class="pill">agenda.json</span></div>
      <div style="margin-left:auto" class="muted" id="status"></div>
    </div>
    <div id="lista"></div>
  </div>

  <div class="card">
    <b>Como funciona o push automático</b>
    <ol>
      <li>Você atualiza os cultos no arquivo <code>agenda.json</code> do GitHub.</li>
      <li>O GitHub Actions roda a cada 15 min, encontra os próximos cultos e agenda dois push: <b>4h antes</b> e <b>1h antes</b>.</li>
      <li>Quem autorizou as notificações recebe no celular/PC automaticamente.</li>
    </ol>
  </div>
</main>

<script>
  document.getElementById('btnPerm').addEventListener('click', async () => {
    if (!window.OneSignalDeferred) return;
    window.OneSignalDeferred.push(async function(OneSignal) {
      try {
        await OneSignal.Notifications.requestPermission();
        document.getElementById('status').textContent = "Notificações: autorizadas ✅";
      } catch (e) {
        document.getElementById('status').textContent = "Notificações: não autorizadas ❌";
      }
    });
  });

  async function carregarAgenda(){
    const res = await fetch('agenda.json?ts=' + Date.now());
    const data = await res.json();
    return data.events || [];
  }

  function fmt(dt){
    const d = new Date(dt);
    return d.toLocaleString('pt-BR', { weekday:'short', day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
  }

  function cardEvento(ev){
    return `
      <div class="card" style="margin:10px 0">
        <div class="row">
          <div style="font-weight:800">${ev.title || 'Culto'}</div>
          <div class="pill">${ev.location || 'CCB'}</div>
        </div>
        <div class="muted">${fmt(ev.start)}${ev.end ? ' – ' + fmt(ev.end) : ''}</div>
        <div class="muted">${ev.notes ? ev.notes : ''}</div>
      </div>
    `;
  }

  (async()=>{
    const lista = document.getElementById('lista');
    const events = await carregarAgenda();
    const now = Date.now();
    const upcoming = events
      .map(e => ({...e, _t: new Date(e.start).getTime()}))
      .filter(e => !isNaN(e._t) && e._t > now - 3600_000)
      .sort((a,b)=>a._t-b._t)
      .slice(0, 20);
    lista.innerHTML = upcoming.length ? upcoming.map(cardEvento).join('') : '<div class="muted">Sem eventos próximos.</div>';
  })();
</script>
</body>
</html>
