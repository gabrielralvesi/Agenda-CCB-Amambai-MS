<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Agenda CCB ‚Äî Amambai</title>
  
  <!-- PWA Meta Tags -->
  <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22Agenda%20CCB%20Amambai%22%2C%22short_name%22%3A%22Agenda%20CCB%22%2C%22description%22%3A%22Cultos%2C%20Reuni%C3%B5es%20e%20Festas%20Espirituais%22%2C%22start_url%22%3A%22%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230b1220%22%2C%22theme_color%22%3A%22%230f172a%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%230f172a%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2265%22%20font-size%3D%2250%22%20text-anchor%3D%22middle%22%20fill%3D%22%23ffffff%22%3EC%3C%2Ftext%3E%3C%2Fsvg%3E%22%7D%5D%7D">
  <meta name="theme-color" content="#0f172a">
  
  <!-- Leaflet CSS (para mapas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    /* RESET E VARI√ÅVEIS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0b1220;
      --card: #0b152a;
      --text: #e5e7eb;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: rgba(148, 163, 184, 0.22);
      --glass: rgba(15, 23, 42, 0.55);
      --shadow: 0 14px 28px rgba(0, 0, 0, 0.28);
      --radius: 18px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="light"] {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --text-muted: #475569;
      --accent: #0ea5e9;
      --border: #e2e8f0;
      --glass: rgba(255, 255, 255, 0.78);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: var(--transition);
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 20px 90px;
    }

    /* GLASS EFFECT */
    .glass {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
    }

    /* HEADER MODERNO */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 20px;
      animation: slideDown 0.5s ease;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--accent), #6366f1);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: white;
      transform: rotate(5deg);
      transition: var(--transition);
    }

    .logo-icon:hover {
      transform: rotate(15deg) scale(1.1);
    }

    .status {
      display: flex;
      gap: 16px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(56, 189, 248, 0.1);
      border: 1px solid rgba(56, 189, 248, 0.2);
      border-radius: 999px;
      font-size: 0.9rem;
    }

    /* BANNER INTERATIVO */
    .banner {
      background: linear-gradient(135deg, 
        rgba(56, 189, 248, 0.2), 
        rgba(34, 197, 94, 0.2),
        rgba(249, 115, 22, 0.2)
      );
      border: 1px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px 24px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      animation: pulse 2s infinite;
      position: relative;
      overflow: hidden;
    }

    .banner::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
      );
      transform: rotate(45deg);
      animation: shine 3s infinite;
    }

    .banner-content {
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
      z-index: 1;
    }

    .banner-icon {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      animation: bounce 2s infinite;
    }

    .banner-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .banner-subtitle {
      color: var(--text-muted);
    }

    .banner-actions {
      display: flex;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    .btn-circle {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .btn-circle:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-4px) rotate(360deg);
    }

    /* CONTROLES */
    .controls {
      padding: 20px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 20px;
    }

    .search-container {
      position: relative;
      margin-bottom: 16px;
    }

    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .search-input {
      width: 100%;
      padding: 14px 16px 14px 48px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--text);
      font-size: 1rem;
      transition: var(--transition);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1);
    }

    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 100;
    }

    .search-container:focus-within .search-suggestions {
      display: block;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid var(--border);
    }

    .suggestion-item:hover {
      background: rgba(56, 189, 248, 0.1);
    }

    .filters {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .toggle input {
      display: none;
    }

    .toggle-slider {
      width: 50px;
      height: 24px;
      background: var(--border);
      border-radius: 999px;
      position: relative;
      transition: var(--transition);
    }

    .toggle-slider:before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: var(--transition);
    }

    .toggle input:checked + .toggle-slider {
      background: var(--accent);
    }

    .toggle input:checked + .toggle-slider:before {
      left: 28px;
    }

    .btn-icon {
      padding: 8px 16px;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text);
      border-radius: 999px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-icon:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
    }

    /* VIEW SELECTOR */
    .view-selector {
      display: flex;
      gap: 8px;
      padding: 4px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 999px;
      margin-bottom: 20px;
      width: fit-content;
    }

    .view-btn {
      padding: 8px 20px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 999px;
      font-weight: 600;
      transition: var(--transition);
    }

    .view-btn:hover {
      color: var(--text);
    }

    .view-btn.active {
      background: var(--accent);
      color: white;
    }

    /* GRID DE EVENTOS */
    .events-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .event-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      animation: fadeIn 0.5s ease;
    }

    .event-card:hover {
      transform: translateY(-6px) scale(1.02);
      border-color: var(--accent);
      box-shadow: 0 20px 30px -10px rgba(56, 189, 248, 0.3);
    }

    .event-card.now {
      border-color: var(--success);
      box-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
    }

    .event-card.next {
      border-color: var(--accent);
      box-shadow: 0 0 30px rgba(56, 189, 248, 0.3);
    }

    .event-tag {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      animation: pulse 2s infinite;
    }

    .event-tag.now {
      background: var(--success);
      color: white;
    }

    .event-tag.next {
      background: var(--accent);
      color: white;
    }

    .event-time {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 12px;
      font-family: 'JetBrains Mono', monospace;
    }

    .event-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .event-place {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .event-progress {
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 16px 0;
      overflow: hidden;
    }

    .event-progress-bar {
      height: 100%;
      background: var(--success);
      transition: width 1s linear;
    }

    .event-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .event-action {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text);
      border-radius: 999px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.9rem;
    }

    .event-action:hover {
      background: var(--accent);
      color: white;
    }

    /* VISUALIZA√á√ÉO SEMANAL */
    .weekly-view {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      margin-bottom: 30px;
    }

    .weekly-day {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      min-height: 500px;
    }

    .weekly-day.today {
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
    }

    .weekly-header {
      font-weight: 700;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }

    .weekly-date {
      font-size: 1.2rem;
      color: var(--accent);
    }

    .weekly-event {
      padding: 10px;
      background: rgba(56, 189, 248, 0.1);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .weekly-event:hover {
      background: rgba(56, 189, 248, 0.2);
      transform: scale(1.02);
    }

    /* VISUALIZA√á√ÉO MENSAL */
    .monthly-view {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 30px;
    }

    .month-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--accent);
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: 700;
    }

    .month-week {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      border-bottom: 1px solid var(--border);
    }

    .month-day {
      min-height: 100px;
      padding: 8px;
      border-right: 1px solid var(--border);
    }

    .month-day.today {
      background: rgba(56, 189, 248, 0.1);
    }

    .month-day-number {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .month-event {
      font-size: 0.7rem;
      padding: 2px 4px;
      background: rgba(56, 189, 248, 0.2);
      border-radius: 2px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    /* MAPA */
    .map-view {
      height: 500px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 30px;
    }

    /* FESTAS */
    .festas-section {
      padding: 20px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-top: 30px;
    }

    .festas-section h3 {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
      font-size: 1.2rem;
    }

    .festas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .festa-card {
      background: linear-gradient(135deg, 
        rgba(56, 189, 248, 0.1), 
        rgba(34, 197, 94, 0.1)
      );
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      transition: var(--transition);
      cursor: pointer;
    }

    .festa-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent);
    }

    .festa-bimestre {
      font-size: 0.8rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .festa-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .festa-details {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px 12px;
      margin: 12px 0;
      font-size: 0.9rem;
    }

    .festa-irmao {
      font-weight: 600;
      color: var(--success);
    }

    /* MODAL */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.3rem;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0 8px;
      transition: var(--transition);
    }

    .modal-close:hover {
      color: var(--danger);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 20px;
    }

    .modal-body p {
      margin: 12px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .modal-footer button {
      flex: 1;
      min-width: 140px;
      padding: 12px;
      border: none;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(56, 189, 248, 0.3);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(34, 197, 94, 0.3);
    }

    /* FAB */
    .fab {
      position: fixed;
      right: 24px;
      bottom: 24px;
      background: linear-gradient(135deg, var(--accent), #6366f1);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 14px 28px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(56, 189, 248, 0.3);
      transition: var(--transition);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }

    .fab:hover {
      transform: translateY(-6px) scale(1.05);
      box-shadow: 0 12px 28px rgba(56, 189, 248, 0.5);
    }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border-left: 4px solid var(--success);
      border-radius: 8px;
      padding: 12px 24px;
      color: var(--text);
      box-shadow: var(--shadow);
      z-index: 1000;
      display: none;
      animation: slideUp 0.3s ease;
    }

    .toast.show {
      display: block;
    }

    /* MODOS */
    .anonimo .festa-irmao,
    .anonimo .event-irmao {
      filter: blur(5px);
      transition: var(--transition);
    }

    .anonimo .festa-irmao:hover,
    .anonimo .event-irmao:hover {
      filter: blur(5px) brightness(1.2);
    }

    /* LOADING */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* ANIMA√á√ïES */
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translate(-50%, 30px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes shine {
      0% {
        transform: translateX(-100%) rotate(45deg);
      }
      20%, 100% {
        transform: translateX(100%) rotate(45deg);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .container {
        padding: 12px 12px 80px;
      }
      
      .weekly-view {
        grid-template-columns: 1fr;
      }
      
      .weekly-day {
        min-height: auto;
      }
      
      .fab span:not(.fab-icon) {
        display: none;
      }
      
      .fab {
        padding: 14px;
        border-radius: 50%;
      }
      
      .banner-content {
        flex-direction: column;
        text-align: center;
      }
      
      .status {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER MODERNO -->
    <header class="header">
      <div class="logo">
        <div class="logo-icon">‚õ™</div>
        <div>
          <h1>Agenda CCB</h1>
          <small style="color: var(--text-muted);">Amambai - MS</small>
        </div>
      </div>
      <div class="status">
        <div class="status-item" id="weather">
          <span>‚òÄÔ∏è</span>
          <span id="temperature">--¬∞C</span>
        </div>
        <div class="status-item" id="date-display">
          <span>üìÖ</span>
          <span id="current-date"></span>
        </div>
      </div>
    </header>

    <!-- BANNER INTERATIVO -->
    <div class="banner" id="banner">
      <div class="banner-content">
        <div class="banner-icon" id="banner-icon">üîî</div>
        <div>
          <div class="banner-title" id="banner-title">Carregando...</div>
          <div class="banner-subtitle" id="banner-subtitle"></div>
        </div>
      </div>
      <div class="banner-actions">
        <button class="btn-circle" onclick="agenda.addCurrentToCalendar()" title="Adicionar ao calend√°rio">üìÖ</button>
        <button class="btn-circle" onclick="agenda.shareCurrent()" title="Compartilhar">üì§</button>
        <button class="btn-circle" onclick="agenda.showMap()" title="Ver no mapa">üó∫Ô∏è</button>
      </div>
    </div>

    <!-- CONTROLES AVAN√áADOS -->
    <div class="controls">
      <div class="search-container">
        <span class="search-icon">üîç</span>
        <input type="search" class="search-input" id="search" placeholder="Buscar eventos, locais, hor√°rios..." autocomplete="off">
        <div class="search-suggestions" id="suggestions"></div>
      </div>
      
      <div class="filters">
        <label class="toggle">
          <input type="checkbox" id="filter-today" onchange="agenda.toggleFilterToday()">
          <span class="toggle-slider"></span>
          <span>S√≥ hoje</span>
        </label>
        
        <label class="toggle">
          <input type="checkbox" id="filter-notifications" onchange="agenda.toggleNotifications()">
          <span class="toggle-slider"></span>
          <span>Notifica√ß√µes</span>
        </label>
        
        <button class="btn-icon" onclick="agenda.toggleTheme()">
          <span id="theme-icon">üåì</span>
          <span>Tema</span>
        </button>
        
        <button class="btn-icon" onclick="agenda.toggleAnonymous()">
          <span>üë§</span>
          <span>An√¥nimo</span>
        </button>
        
        <button class="btn-icon" onclick="agenda.exportData()">
          <span>üì•</span>
          <span>Exportar</span>
        </button>
      </div>
    </div>

    <!-- VIEW SELECTOR -->
    <div class="view-selector">
      <button class="view-btn active" onclick="agenda.setView('daily')">Dia</button>
      <button class="view-btn" onclick="agenda.setView('weekly')">Semana</button>
      <button class="view-btn" onclick="agenda.setView('monthly')">M√™s</button>
      <button class="view-btn" onclick="agenda.setView('map')">Mapa</button>
    </div>

    <!-- VIEWS CONTAINER -->
    <div id="daily-view" class="events-grid"></div>
    
    <div id="weekly-view" class="weekly-view" style="display: none;"></div>
    
    <div id="monthly-view" class="monthly-view" style="display: none;"></div>
    
    <div id="map-view" class="map-view" style="display: none;"></div>

    <!-- FESTAS ESPIRITUAIS -->
    <section class="festas-section">
      <h3>
        <span>‚≠ê</span>
        Festas Espirituais
        <span style="margin-left: auto; font-size: 0.8rem; color: var(--accent);" id="festas-count"></span>
      </h3>
      <div id="festas-grid" class="festas-grid"></div>
    </section>
  </div>

  <!-- FAB -->
  <button class="fab" onclick="agenda.goToToday()">
    <span class="fab-icon">üìå</span>
    <span>HOJE</span>
  </button>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

  <script>
    // AGENDA CCB - VERS√ÉO PREMIUM
    class AgendaCCB {
      constructor() {
        this.dados = {
          cultos: [
            { id: '1', dia: 1, titulo: 'Culto com Recitativos', local: 'Vila Limeira', horario: '19:30', regra: 'all', duracao: 90, cor: '#3b82f6' },
            { id: '2', dia: 2, titulo: 'Culto Oficial', local: 'Vila Gl√≥ria', horario: '19:30', regra: 'all', duracao: 90, cor: '#3b82f6' },
            { id: '3', dia: 3, titulo: 'Culto Oficial', local: 'Central Amambai', horario: '19:30', regra: 'all', duracao: 90, cor: '#3b82f6' },
            { id: '4', dia: 4, titulo: 'Culto Oficial', local: 'Vila Limeira', horario: '19:30', regra: 'all', duracao: 90, cor: '#3b82f6' },
            { id: '5', dia: 4, titulo: 'Culto com Ensaio', local: 'Vila Limeira', horario: '19:30', regra: 'nth:2', duracao: 120, cor: '#8b5cf6' },
            { id: '6', dia: 4, titulo: 'Culto Oficial', local: 'Aldeia Sert√£ozinho', horario: '19:30', regra: 'all', duracao: 90, cor: '#3b82f6' },
            { id: '7', dia: 4, titulo: 'Culto com Recitativos', local: 'Aldeia Sert√£ozinho', horario: '19:30', regra: 'nth:3', duracao: 90, cor: '#8b5cf6' },
            { id: '8', dia: 5, titulo: 'Ensaio Local', local: 'Central Amambai', horario: '19:30', regra: 'nth:1', duracao: 120, cor: '#8b5cf6' },
            { id: '9', dia: 5, titulo: 'Ensaio Local', local: 'Vila Cristina', horario: '19:30', regra: 'nth:3', duracao: 120, cor: '#8b5cf6' },
            { id: '10', dia: 5, titulo: 'Ensaio Local', local: 'Vila Gl√≥ria', horario: '19:30', regra: 'nth:4', duracao: 120, cor: '#8b5cf6' },
            { id: '11', dia: 6, titulo: 'Evangeliza√ß√£o', local: 'Pres√≠dio', horario: '09:00', regra: 'all', duracao: 60, cor: '#10b981' },
            { id: '12', dia: 6, titulo: 'Evangeliza√ß√£o', local: 'Lar do Idoso', horario: '15:00', regra: 'nth:2,4', duracao: 60, cor: '#10b981' },
            { id: '13', dia: 6, titulo: 'Culto Oficial', local: 'Aldeia Lim√£o Verde', horario: '16:00', regra: 'all', duracao: 90, cor: '#3b82f6' },
            { id: '14', dia: 6, titulo: 'Culto com Recitativos', local: 'Aldeia Invernada', horario: '18:30', regra: 'nth:2', duracao: 90, cor: '#8b5cf6' },
            { id: '15', dia: 6, titulo: 'Culto Oficial', local: 'Central Amambai', horario: '19:30', regra: 'all', duracao: 90, cor: '#3b82f6' },
            { id: '16', dia: 0, titulo: 'Jovens e Menores', local: 'Central Amambai', horario: '09:30', regra: 'all', duracao: 60, cor: '#10b981' },
            { id: '17', dia: 0, titulo: 'Jovens e Menores', local: 'Vila Cristina', horario: '09:30', regra: 'all', duracao: 60, cor: '#10b981' },
            { id: '18', dia: 0, titulo: 'Culto Oficial', local: 'Aldeia Central', horario: '15:00', regra: 'all', duracao: 90, cor: '#3b82f6' },
            { id: '19', dia: 0, titulo: 'Culto com Recitativo', local: 'Aldeia Central', horario: '15:00', regra: 'nth:1,3', duracao: 90, cor: '#8b5cf6' },
            { id: '20', dia: 0, titulo: 'Culto com Ensaio', local: 'Aldeia Central', horario: '15:00', regra: 'nth:4', duracao: 120, cor: '#8b5cf6' },
            { id: '21', dia: 0, titulo: 'Culto com Recitativos', local: 'Vila Gl√≥ria', horario: '19:00', regra: 'all', duracao: 90, cor: '#3b82f6' },
            { id: '22', dia: 0, titulo: 'Culto Oficial', local: 'Central Amambai', horario: '19:00', regra: 'all', duracao: 90, cor: '#3b82f6' },
            { id: '23', dia: 0, titulo: 'Culto Oficial', local: 'Vila Cristina', horario: '19:00', regra: 'all', duracao: 90, cor: '#3b82f6' }
          ],
          festas: [
            { id: 'f1', bimestre: 'Jan/Fev', titulo: 'Busca dos Dons', data: '2026-02-21', horario: '19:30', local: 'Central Amambai', irmao: 'Mois√©s Crepaldi' },
            { id: 'f2', bimestre: 'Jan/Fev', titulo: 'Culto para Mocidade', data: '2026-02-26', horario: '19:30', local: 'Aldeia Sert√£ozinho', irmao: 'Jo√£o Butarelli' },
            { id: 'f3', bimestre: 'Mar/Abr', titulo: 'Santa Ceia', data: '2026-03-21', horario: '19:30', local: 'Central Amambai', irmao: 'Antonio Silva' },
            { id: 'f4', bimestre: 'Mar/Abr', titulo: 'Batismo', data: '2026-04-18', horario: '19:30', local: 'Vila Limeira', irmao: 'Jos√© Oliveira' }
          ]
        };
        
        this.diasSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
        this.diasAbrev = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        this.meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        
        this.modoAnonimo = false;
        this.notificacoesAtivas = false;
        this.viewAtual = 'daily';
        this.eventoAtual = null;
        this.proximoEvento = null;
        this.searchTimeout = null;
        this.map = null;
        this.markers = [];
        
        this.init();
      }

      async init() {
        this.carregarPreferencias();
        this.atualizarDataHora();
        await this.atualizarClima();
        this.renderizar();
        this.configurarEventListeners();
        this.configurarAtalhos();
        this.iniciarAtualizacao();
        this.solicitarPermissaoNotificacoes();
      }

      carregarPreferencias() {
        // Tema
        const tema = localStorage.getItem('tema') || 'dark';
        document.documentElement.setAttribute('data-theme', tema);
        document.getElementById('theme-icon').textContent = tema === 'dark' ? 'üåì' : '‚òÄÔ∏è';
        
        // Modo an√¥nimo
        this.modoAnonimo = localStorage.getItem('anonimo') === 'true';
        if (this.modoAnonimo) document.body.classList.add('anonimo');
        
        // Notifica√ß√µes
        this.notificacoesAtivas = localStorage.getItem('notificacoes') === 'true';
        if (document.getElementById('filter-notifications')) {
          document.getElementById('filter-notifications').checked = this.notificacoesAtivas;
        }
        
        // Filtro hoje
        const filterToday = localStorage.getItem('filterToday') === 'true';
        if (document.getElementById('filter-today')) {
          document.getElementById('filter-today').checked = filterToday;
        }
      }

      atualizarDataHora() {
        const agora = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').textContent = agora.toLocaleDateString('pt-BR', options);
        
        // Atualizar a cada segundo
        setInterval(() => {
          const now = new Date();
          const time = now.toLocaleTimeString('pt-BR');
          // Atualizar rel√≥gio se existir
        }, 1000);
      }

      async atualizarClima() {
        try {
          // Usando API gratuita do Open-Meteo
          const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=-23.1&longitude=-55.2&current_weather=true');
          const data = await response.json();
          const temp = Math.round(data.current_weather.temperature);
          document.getElementById('temperature').textContent = `${temp}¬∞C`;
          
          const weatherCode = data.current_weather.weathercode;
          const icon = this.getWeatherIcon(weatherCode);
          document.querySelector('#weather span:first-child').textContent = icon;
        } catch (e) {
          // Fallback para temperatura simulada
          const temp = Math.floor(Math.random() * 10 + 25);
          document.getElementById('temperature').textContent = `${temp}¬∞C`;
        }
      }

      getWeatherIcon(code) {
        const icons = {
          0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
          45: 'üå´Ô∏è', 48: 'üå´Ô∏è', 51: 'üåßÔ∏è', 61: 'üåßÔ∏è',
          71: 'üå®Ô∏è', 95: '‚õàÔ∏è'
        };
        return icons[code] || '‚òÄÔ∏è';
      }

      renderizar() {
        const eventosFiltrados = this.filtrarEventos();
        
        if (this.viewAtual === 'daily') {
          this.renderizarDaily(eventosFiltrados);
        } else if (this.viewAtual === 'weekly') {
          this.renderizarWeekly(eventosFiltrados);
        } else if (this.viewAtual === 'monthly') {
          this.renderizarMonthly();
        } else if (this.viewAtual === 'map') {
          this.renderizarMapa();
        }
        
        this.renderizarFestas();
        this.atualizarBanner();
        this.atualizarContadores();
      }

      filtrarEventos() {
        const termo = document.getElementById('search')?.value.toLowerCase() || '';
        const soHoje = document.getElementById('filter-today')?.checked || false;
        const hoje = new Date().getDay();
        
        return this.dados.cultos.filter(e => {
          // Filtro de busca
          if (termo) {
            const texto = `${e.titulo} ${e.local} ${e.horario}`.toLowerCase();
            if (!texto.includes(termo)) return false;
          }
          
          // Filtro "s√≥ hoje"
          if (soHoje && e.dia !== hoje) return false;
          
          // Filtro de regra (nth)
          if (e.regra !== 'all') {
            const semana = this.getSemanaDoMes(new Date());
            const semanas = e.regra.replace('nth:', '').split(',').map(Number);
            if (!semanas.includes(semana)) return false;
          }
          
          return true;
        }).sort((a, b) => a.horario.localeCompare(b.horario));
      }

      getSemanaDoMes(data) {
        const primeiroDia = new Date(data.getFullYear(), data.getMonth(), 1);
        return Math.ceil((data.getDate() + primeiroDia.getDay()) / 7);
      }

      renderizarDaily(eventos) {
        const container = document.getElementById('daily-view');
        const hoje = new Date().getDay();
        
        // Agrupar por dia
        const eventosPorDia = {};
        eventos.forEach(e => {
          if (!eventosPorDia[e.dia]) eventosPorDia[e.dia] = [];
          eventosPorDia[e.dia].push(e);
        });
        
        let html = '';
        for (let dia = 0; dia < 7; dia++) {
          const eventosDia = eventosPorDia[dia] || [];
          const isHoje = dia === hoje;
          
          eventosDia.forEach(e => {
            html += this.criarCardEvento(e, isHoje);
          });
        }
        
        container.innerHTML = html || '<div class="loading"><div class="spinner"></div></div>';
      }

      criarCardEvento(e, isHoje) {
        const agora = new Date();
        const [h, m] = e.horario.split(':').map(Number);
        const eventoHoje = new Date();
        eventoHoje.setHours(h, m, 0);
        
        const diffMin = (eventoHoje - agora) / (1000 * 60);
        const isNow = diffMin <= 45 && diffMin > -e.duracao;
        const isNext = diffMin > 0 && diffMin < 120;
        const isPast = diffMin < -e.duracao;
        
        let tag = '';
        let progress = '';
        
        if (isNow) {
          tag = '<span class="event-tag now">üî¥ AGORA</span>';
          const progressPercent = Math.min(100, ((45 - diffMin) / 45) * 100);
          progress = `
            <div class="event-progress">
              <div class="event-progress-bar" style="width: ${progressPercent}%"></div>
            </div>
          `;
        } else if (isNext) {
          tag = '<span class="event-tag next">‚è∞ PR√ìXIMO</span>';
        } else if (isHoje) {
          tag = '<span class="event-tag" style="background: var(--accent);">üìÖ HOJE</span>';
        }
        
        return `
          <div class="event-card ${isNow ? 'now' : ''} ${isNext ? 'next' : ''} ${isPast ? 'past' : ''}" 
               onclick="agenda.verDetalhes('${e.id}')"
               style="border-left: 4px solid ${e.cor}">
            ${tag}
            <div class="event-time">${e.horario}</div>
            <div class="event-title">${e.titulo}</div>
            <div class="event-place">
              <span>üìç</span>
              <span>${e.local}</span>
            </div>
            ${progress}
            <div class="event-actions">
              <button class="event-action" onclick="event.stopPropagation(); agenda.addToCalendar('${e.id}')">
                <span>üìÖ</span>
                <span>Calend√°rio</span>
              </button>
              <button class="event-action" onclick="event.stopPropagation(); agenda.share('${e.id}')">
                <span>üì§</span>
                <span>Compartilhar</span>
              </button>
              <button class="event-action" onclick="event.stopPropagation(); agenda.showOnMap('${e.local}')">
                <span>üó∫Ô∏è</span>
                <span>Mapa</span>
              </button>
            </div>
          </div>
        `;
      }

      renderizarWeekly(eventos) {
        const container = document.getElementById('weekly-view');
        const hoje = new Date();
        const semana = [];
        
        for (let i = 0; i < 7; i++) {
          const data = new Date(hoje);
          data.setDate(hoje.getDate() + i);
          semana.push(data);
        }
        
        let html = '';
        semana.forEach((data, index) => {
          const diaSemana = data.getDay();
          const eventosDia = eventos.filter(e => e.dia === diaSemana);
          const isHoje = data.toDateString() === hoje.toDateString();
          
          html += `
            <div class="weekly-day ${isHoje ? 'today' : ''}">
              <div class="weekly-header">
                <div>${this.diasAbrev[diaSemana]}</div>
                <div class="weekly-date">${data.getDate()}</div>
              </div>
              ${eventosDia.map(e => `
                <div class="weekly-event" onclick="agenda.verDetalhes('${e.id}')">
                  <strong>${e.horario}</strong><br>
                  ${e.titulo}<br>
                  <small>${e.local}</small>
                </div>
              `).join('')}
            </div>
          `;
        });
        
        container.innerHTML = html;
        container.style.display = 'grid';
        document.getElementById('daily-view').style.display = 'none';
        document.getElementById('monthly-view').style.display = 'none';
        document.getElementById('map-view').style.display = 'none';
      }

      renderizarMonthly() {
        const container = document.getElementById('monthly-view');
        const hoje = new Date();
        const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        
        let html = `
          <div class="month-header">
            ${this.diasAbrev.map(d => `<div>${d}</div>`).join('')}
          </div>
        `;
        
        let dias = [];
        
        // Dias vazios no in√≠cio
        for (let i = 0; i < primeiroDia.getDay(); i++) {
          dias.push('<div class="month-day"></div>');
        }
        
        // Dias do m√™s
        for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
          const data = new Date(hoje.getFullYear(), hoje.getMonth(), dia);
          const diaSemana = data.getDay();
          const eventosDia = this.dados.cultos.filter(e => e.dia === diaSemana);
          const isHoje = data.toDateString() === hoje.toDateString();
          
          dias.push(`
            <div class="month-day ${isHoje ? 'today' : ''}">
              <div class="month-day-number">${dia}</div>
              ${eventosDia.slice(0, 2).map(e => `
                <div class="month-event" onclick="agenda.verDetalhes('${e.id}')">
                  ${e.horario} - ${e.titulo}
                </div>
              `).join('')}
              ${eventosDia.length > 2 ? `<div style="font-size: 0.7rem;">+${eventosDia.length - 2}</div>` : ''}
            </div>
          `);
        }
        
        // Completar grid
        while (dias.length % 7 !== 0) {
          dias.push('<div class="month-day"></div>');
        }
        
        // Dividir em semanas
        for (let i = 0; i < dias.length; i += 7) {
          html += `<div class="month-week">${dias.slice(i, i + 7).join('')}</div>`;
        }
        
        container.innerHTML = html;
        container.style.display = 'block';
        document.getElementById('daily-view').style.display = 'none';
        document.getElementById('weekly-view').style.display = 'none';
        document.getElementById('map-view').style.display = 'none';
      }

      renderizarMapa() {
        const container = document.getElementById('map-view');
        container.style.display = 'block';
        document.getElementById('daily-view').style.display = 'none';
        document.getElementById('weekly-view').style.display = 'none';
        document.getElementById('monthly-view').style.display = 'none';
        
        if (!this.map) {
          this.map = L.map('map-view').setView([-23.1057, -55.2253], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
          }).addTo(this.map);
        }
        
        // Limpar marcadores antigos
        this.markers.forEach(m => m.remove());
        this.markers = [];
        
        // Adicionar marcadores para locais √∫nicos
        const locais = [...new Set(this.dados.cultos.map(e => e.local))];
        locais.forEach(local => {
          const marker = L.marker([-23.1057 + (Math.random() * 0.1 - 0.05), -55.2253 + (Math.random() * 0.1 - 0.05)]).addTo(this.map);
          marker.bindPopup(`<b>${local}</b><br><button onclick="agenda.filtrarLocal('${local}')">Ver eventos</button>`);
          this.markers.push(marker);
        });
        
        setTimeout(() => this.map.invalidateSize(), 100);
      }

      renderizarFestas() {
        const container = document.getElementById('festas-grid');
        
        container.innerHTML = this.dados.festas.map(f => `
          <div class="festa-card" onclick="agenda.verDetalhesFesta('${f.id}')">
            <div class="festa-bimestre">${f.bimestre}</div>
            <div class="festa-title">${f.titulo}</div>
            <div class="festa-details">
              <span>üìÖ</span> <span>${new Date(f.data).toLocaleDateString('pt-BR')}</span>
              <span>‚è∞</span> <span>${f.horario}</span>
              <span>üìç</span> <span>${f.local}</span>
              <span>üë§</span> <span class="festa-irmao">Ir. ${f.irmao}</span>
            </div>
          </div>
        `).join('');
        
        document.getElementById('festas-count').textContent = `${this.dados.festas.length} festas`;
      }

      atualizarBanner() {
        const agora = new Date();
        const horaAtual = agora.getHours() * 60 + agora.getMinutes();
        
        // Encontrar evento atual ou pr√≥ximo
        const eventosHoje = this.dados.cultos.filter(e => e.dia === agora.getDay());
        
        let eventoAtual = null;
        let eventoProximo = null;
        
        eventosHoje.forEach(e => {
          const [h, m] = e.horario.split(':').map(Number);
          const minutosEvento = h * 60 + m;
          
          if (minutosEvento <= horaAtual && horaAtual < minutosEvento + e.duracao) {
            eventoAtual = e;
          } else if (minutosEvento > horaAtual && (!eventoProximo || minutosEvento < this.getMinutosEvento(eventoProximo))) {
            eventoProximo = e;
          }
        });
        
        const title = document.getElementById('banner-title');
        const subtitle = document.getElementById('banner-subtitle');
        const icon = document.getElementById('banner-icon');
        
        if (eventoAtual) {
          title.textContent = `üî¥ AGORA: ${eventoAtual.titulo}`;
          subtitle.textContent = `${eventoAtual.local} ¬∑ at√© ${this.calcularFim(eventoAtual)}`;
          icon.textContent = 'üîî';
        } else if (eventoProximo) {
          const diff = this.calcularDiferenca(eventoProximo);
          title.textContent = `‚è∞ PR√ìXIMO: ${eventoProximo.titulo}`;
          subtitle.textContent = `${eventoProximo.local} ¬∑ em ${diff}`;
          icon.textContent = '‚è∞';
        } else {
          title.textContent = 'üìÖ Nenhum evento hoje';
          subtitle.textContent = 'Volte amanh√£ para mais cultos';
          icon.textContent = 'üìÖ';
        }
      }

      getMinutosEvento(e) {
        const [h, m] = e.horario.split(':').map(Number);
        return h * 60 + m;
      }

      calcularFim(e) {
        const [h, m] = e.horario.split(':').map(Number);
        const fimMin = h * 60 + m + e.duracao;
        const fimH = Math.floor(fimMin / 60);
        const fimM = fimMin % 60;
        return `${fimH.toString().padStart(2, '0')}:${fimM.toString().padStart(2, '0')}`;
      }

      calcularDiferenca(e) {
        const agora = new Date();
        const [h, m] = e.horario.split(':').map(Number);
        const eventoHoje = new Date();
        eventoHoje.setHours(h, m, 0);
        
        const diffMin = Math.round((eventoHoje - agora) / (1000 * 60));
        
        if (diffMin < 60) return `${diffMin} min`;
        const horas = Math.floor(diffMin / 60);
        const minutos = diffMin % 60;
        return `${horas}h${minutos > 0 ? ` ${minutos}min` : ''}`;
      }

      atualizarContadores() {
        const totalEventos = this.dados.cultos.length;
        const festasCount = this.dados.festas.length;
        // Atualizar contadores na UI
      }

      verDetalhes(id) {
        const evento = this.dados.cultos.find(e => e.id === id);
        if (!evento) return;
        
        const agora = new Date();
        const [h, m] = evento.horario.split(':').map(Number);
        const eventoHoje = new Date();
        eventoHoje.setHours(h, m, 0);
        
        const diffMin = (eventoHoje - agora) / (1000 * 60);
        const status = diffMin <= 45 && diffMin > -evento.duracao ? 'Acontecendo agora' :
                      diffMin > 0 ? `Come√ßa em ${this.calcularDiferenca(evento)}` :
                      'Evento j√° passou';
        
        this.mostrarModal(`
          <h2>${evento.titulo}</h2>
          <div style="margin: 20px 0;">
            <p>‚è∞ ${evento.horario} (${evento.duracao} minutos)</p>
            <p>üìç ${evento.local}</p>
            <p>üìÖ ${this.diasSemana[evento.dia]}</p>
            <p>üîî ${status}</p>
            ${evento.regra !== 'all' ? `<p>üìå Evento especial: ${this.formatarRegra(evento.regra)}</p>` : ''}
          </div>
        `, [
          { text: 'üìÖ Calend√°rio', action: () => this.addToCalendar(evento.id), class: 'btn-primary' },
          { text: 'üì§ Compartilhar', action: () => this.share(evento.id), class: 'btn-success' },
          { text: 'üó∫Ô∏è Mapa', action: () => this.showOnMap(evento.local), class: 'btn-primary' },
          { text: 'Fechar', action: 'close', class: 'btn-secondary' }
        ]);
      }

      verDetalhesFesta(id) {
        const festa = this.dados.festas.find(f => f.id === id);
        if (!festa) return;
        
        this.mostrarModal(`
          <h2>${festa.titulo}</h2>
          <div style="margin: 20px 0;">
            <p>üìÖ ${new Date(festa.data).toLocaleDateString('pt-BR')}</p>
            <p>‚è∞ ${festa.horario}</p>
            <p>üìç ${festa.local}</p>
            <p>üë§ Ir. ${festa.irmao}</p>
          </div>
        `, [
          { text: 'üì§ Compartilhar', action: () => this.shareFesta(festa.id), class: 'btn-success' },
          { text: 'üó∫Ô∏è Mapa', action: () => this.showOnMap(festa.local), class: 'btn-primary' },
          { text: 'Fechar', action: 'close', class: 'btn-secondary' }
        ]);
      }

      mostrarModal(content, buttons = []) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        const buttonsHtml = buttons.map(b => `
          <button class="${b.class || 'btn-primary'}" 
                  onclick="${b.action === 'close' ? 'this.closest(\'.modal\').remove()' : 'agenda.' + b.action}">
            ${b.text}
          </button>
        `).join('');
        
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              ${content}
              <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="modal-footer">
              ${buttonsHtml}
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      addToCalendar(id) {
        const evento = this.dados.cultos.find(e => e.id === id);
        if (!evento) return;
        
        const texto = `${evento.titulo} em ${evento.local} √†s ${evento.horario}`;
        navigator.clipboard.writeText(texto).then(() => {
          this.toast('‚úÖ Evento copiado! Cole no seu calend√°rio');
        });
      }

      share(id) {
        const evento = this.dados.cultos.find(e => e.id === id);
        if (!evento) return;
        
        const texto = `*${evento.titulo}*\nüìç ${evento.local}\n‚è∞ ${evento.horario}\nüìÖ ${this.diasSemana[evento.dia]}`;
        
        if (navigator.share) {
          navigator.share({ title: evento.titulo, text: texto });
        } else {
          navigator.clipboard.writeText(texto).then(() => {
            this.toast('‚úÖ Evento copiado!');
          });
        }
      }

      shareFesta(id) {
        const festa = this.dados.festas.find(f => f.id === id);
        if (!festa) return;
        
        const texto = `*${festa.titulo}*\nüìÖ ${new Date(festa.data).toLocaleDateString('pt-BR')}\n‚è∞ ${festa.horario}\nüìç ${festa.local}\nüë§ Ir. ${festa.irmao}`;
        
        if (navigator.share) {
          navigator.share({ title: festa.titulo, text: texto });
        } else {
          navigator.clipboard.writeText(texto).then(() => {
            this.toast('‚úÖ Festa copiada!');
          });
        }
      }

      showOnMap(local) {
        this.setView('map');
        // Destacar marcador do local
        this.toast(`üìç Localizando: ${local}`);
      }

      addCurrentToCalendar() {
        const agora = new Date();
        const eventosHoje = this.dados.cultos.filter(e => e.dia === agora.getDay());
        if (eventosHoje.length > 0) {
          this.addToCalendar(eventosHoje[0].id);
        }
      }

      shareCurrent() {
        const agora = new Date();
        const eventosHoje = this.dados.cultos.filter(e => e.dia === agora.getDay());
        if (eventosHoje.length > 0) {
          this.share(eventosHoje[0].id);
        }
      }

      showMap() {
        this.setView('map');
      }

      filtrarLocal(local) {
        document.getElementById('search').value = local;
        this.renderizar();
        this.toast(`üîç Filtrando: ${local}`);
      }

      setView(view) {
        this.viewAtual = view;
        
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent.toLowerCase().includes(view)) {
            btn.classList.add('active');
          }
        });
        
        this.renderizar();
      }

      toggleFilterToday() {
        const checked = document.getElementById('filter-today').checked;
        localStorage.setItem('filterToday', checked);
        this.renderizar();
      }

      async toggleNotifications() {
        this.notificacoesAtivas = document.getElementById('filter-notifications').checked;
        localStorage.setItem('notificacoes', this.notificacoesAtivas);
        
        if (this.notificacoesAtivas && 'Notification' in window) {
          const permission = await Notification.requestPermission();
          if (permission === 'granted') {
            this.toast('üîî Notifica√ß√µes ativadas!');
          }
        }
      }

      toggleTheme() {
        const atual = document.documentElement.getAttribute('data-theme');
        const novo = atual === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', novo);
        localStorage.setItem('tema', novo);
        document.getElementById('theme-icon').textContent = novo === 'dark' ? 'üåì' : '‚òÄÔ∏è';
        this.toast(`üé® Modo ${novo === 'dark' ? 'escuro' : 'claro'}`);
      }

      toggleAnonymous() {
        this.modoAnonimo = !this.modoAnonimo;
        document.body.classList.toggle('anonimo', this.modoAnonimo);
        localStorage.setItem('anonimo', this.modoAnonimo);
        this.toast(this.modoAnonimo ? 'üë§ Modo an√¥nimo ativado' : 'üë§ Modo an√¥nimo desativado');
      }

      exportData() {
        const dataStr = JSON.stringify(this.dados, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `agenda-ccb-${new Date().toISOString().split('T')[0]}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        this.toast('üì• Dados exportados!');
      }

      goToToday() {
        if (this.viewAtual !== 'daily') {
          this.setView('daily');
        }
        
        setTimeout(() => {
          const hoje = new Date().getDay();
          const cards = document.querySelectorAll('.event-card');
          for (let card of cards) {
            if (card.querySelector('.event-tag')?.textContent.includes('HOJE')) {
              card.scrollIntoView({ behavior: 'smooth', block: 'center' });
              card.style.transform = 'scale(1.02)';
              setTimeout(() => card.style.transform = '', 500);
              break;
            }
          }
        }, 100);
        
        this.toast('üìå Rolando para hoje');
      }

      formatarRegra(regra) {
        if (regra === 'all') return '';
        return regra.replace('nth:', '').split(',').map(s => `${s}¬∫`).join('/');
      }

      configurarEventListeners() {
        // Busca com debounce
        document.getElementById('search').addEventListener('input', (e) => {
          clearTimeout(this.searchTimeout);
          this.searchTimeout = setTimeout(() => {
            this.renderizar();
            this.atualizarSugestoes(e.target.value);
          }, 300);
        });
      }

      atualizarSugestoes(termo) {
        if (!termo) {
          document.getElementById('suggestions').style.display = 'none';
          return;
        }
        
        const sugestoes = [];
        
        // Sugest√µes de t√≠tulos
        this.dados.cultos.forEach(e => {
          if (e.titulo.toLowerCase().includes(termo.toLowerCase()) && !sugestoes.some(s => s.texto === e.titulo)) {
            sugestoes.push({ tipo: 'culto', texto: e.titulo, icon: '‚õ™' });
          }
        });
        
        // Sugest√µes de locais
        const locais = [...new Set(this.dados.cultos.map(e => e.local))];
        locais.forEach(l => {
          if (l.toLowerCase().includes(termo.toLowerCase())) {
            sugestoes.push({ tipo: 'local', texto: l, icon: 'üìç' });
          }
        });
        
        if (sugestoes.length > 0) {
          const html = sugestoes.slice(0, 5).map(s => `
            <div class="suggestion-item" onclick="document.getElementById('search').value = '${s.texto}'; agenda.renderizar(); document.getElementById('suggestions').style.display = 'none';">
              <span>${s.icon}</span>
              <span>${s.texto}</span>
            </div>
          `).join('');
          
          document.getElementById('suggestions').innerHTML = html;
          document.getElementById('suggestions').style.display = 'block';
        } else {
          document.getElementById('suggestions').style.display = 'none';
        }
      }

      configurarAtalhos() {
        document.addEventListener('keydown', (e) => {
          // Ctrl+F ou / para buscar
          if ((e.ctrlKey && e.key === 'f') || e.key === '/') {
            e.preventDefault();
            document.getElementById('search').focus();
          }
          
          // Esc para limpar busca
          if (e.key === 'Escape') {
            document.getElementById('search').value = '';
            this.renderizar();
            document.getElementById('suggestions').style.display = 'none';
          }
          
          // N√∫meros para views (1-4)
          if (e.altKey && e.key >= '1' && e.key <= '4') {
            const views = ['daily', 'weekly', 'monthly', 'map'];
            this.setView(views[parseInt(e.key) - 1]);
          }
          
          // T para tema
          if (e.altKey && e.key === 't') {
            this.toggleTheme();
          }
          
          // H para hoje
          if (e.altKey && e.key === 'h') {
            this.goToToday();
          }
        });
      }

      iniciarAtualizacao() {
        // Atualizar a cada minuto
        setInterval(() => {
          this.atualizarBanner();
          
          // Verificar notifica√ß√µes
          if (this.notificacoesAtivas && 'Notification' in window && Notification.permission === 'granted') {
            this.verificarNotificacoes();
          }
        }, 60000);
        
        // Atualizar clima a cada 30 minutos
        setInterval(() => this.atualizarClima(), 1800000);
      }

      verificarNotificacoes() {
        const agora = new Date();
        const horaAtual = agora.getHours() * 60 + agora.getMinutes();
        
        this.dados.cultos.forEach(e => {
          if (e.dia !== agora.getDay()) return;
          
          const [h, m] = e.horario.split(':').map(Number);
          const minutosEvento = h * 60 + m;
          
          // Notificar 30 minutos antes
          if (minutosEvento - horaAtual === 30) {
            new Notification('üîî Lembrete de Culto', {
              body: `${e.titulo} em ${e.local} √†s ${e.horario}`,
              icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%230f172a"/><text x="50" y="65" font-size="50" text-anchor="middle" fill="%23ffffff">‚õ™</text></svg>'
            });
          }
          
          // Notificar na hora
          if (minutosEvento === horaAtual) {
            new Notification('üîî Culto Come√ßando Agora!', {
              body: `${e.titulo} em ${e.local}`,
              icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%230f172a"/><text x="50" y="65" font-size="50" text-anchor="middle" fill="%23ffffff">‚õ™</text></svg>'
            });
          }
        });
      }

      async solicitarPermissaoNotificacoes() {
        if ('Notification' in window && this.notificacoesAtivas && Notification.permission === 'default') {
          await Notification.requestPermission();
        }
      }

      toast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      }
    }

    // Inicializar
    const agenda = new AgendaCCB();
  </script>
</body>
</html>
