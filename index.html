<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda CCB ‚Äî Amambai</title>
  <meta name="theme-color" content="#0f172a">
  
  <!-- PWA - √çcone CCB (corrigido) -->
  <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22Agenda%20CCB%20Amambai%22%2C%22short_name%22%3A%22CCB%22%2C%22start_url%22%3A%22%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230f172a%22%2C%22theme_color%22%3A%22%230f172a%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data:image/svg+xml,%3Csvg%20xmlns%3D%27http://www.w3.org/2000/svg%27%20viewBox%3D%270%200%20100%20100%27%3E%3Crect%20width%3D%27100%27%20height%3D%27100%27%20fill%3D%27%230f172a%27%2F%3E%3Ctext%20x%3D%2750%27%20y%3D%2765%27%20font-size%3D%2750%27%20text-anchor%3D%27middle%27%20fill%3D%27%23ffffff%27%20font-family%3D%27Arial%2C%20Helvetica%2C%20sans-serif%27%20font-weight%3D%27bold%27%3ECCB%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%2C%7B%22src%22%3A%22data:image/svg+xml,%3Csvg%20xmlns%3D%27http://www.w3.org/2000/svg%27%20viewBox%3D%270%200%20100%20100%27%3E%3Crect%20width%3D%27100%27%20height%3D%27100%27%20fill%3D%27%230f172a%27%2F%3E%3Ctext%20x%3D%2750%27%20y%3D%2765%27%20font-size%3D%2750%27%20text-anchor%3D%27middle%27%20fill%3D%27%23ffffff%27%20font-family%3D%27Arial%2C%20Helvetica%2C%20sans-serif%27%20font-weight%3D%27bold%27%3ECCB%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CCB Amambai">
  
  <!-- √çcone para iOS (Apple) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http://www.w3.org/2000/svg%27%20viewBox%3D%270%200%20100%20100%27%3E%3Crect%20width%3D%27100%27%20height%3D%27100%27%20fill%3D%27%230f172a%27%2F%3E%3Ctext%20x%3D%2750%27%20y%3D%2765%27%20font-size%3D%2750%27%20text-anchor%3D%27middle%27%20fill%3D%27%23ffffff%27%20font-family%3D%27Arial%2C%20Helvetica%2C%20sans-serif%27%20font-weight%3D%27bold%27%3ECCB%3C%2Ftext%3E%3C%2Fsvg%3E">
  
  <!-- ONESIGNAL -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "bae41e89-0fc8-4e28-a8ba-ca1eea7d4626",
        safari_web_id: "web.onesignal.auto._______",
        allowLocalhostAsSecureOrigin: true,
        serviceWorkerParam: { scope: '/' },
        serviceWorkerPath: 'OneSignalSDKWorker.js',
        notificationClickHandlerAction: 'focus',
        promptOptions: {
          slidedown: {
            prompts: [{
              type: "push",
              autoPrompt: true,
              text: {
                acceptButton: "PERMITIR",
                cancelButton: "AGORA N√ÉO",
                mainMessage: "üîî Receba notifica√ß√µes da igreja",
                optOutMessage: "Notifica√ß√µes desativadas",
                acceptButtonHtml: "PERMITIR",
                cancelButtonHtml: "AGORA N√ÉO",
              }
            }]
          }
        }
      });
      
      OneSignal.Slidedown.promptPush();
    });
  </script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root{
      --bg:#0b1220; --card:#0b152a; --text:#e5e7eb; --text-light:#94a3b8;
      --accent:#38bdf8; --success:#22c55e; --warning:#f59e0b; --danger:#ef4444;
      --border:rgba(148,163,184,0.22); --glass:rgba(15,23,42,0.55); --radius:18px;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --text-light:#475569;
      --accent:#0ea5e9; --border:#e2e8f0; --glass:rgba(255,255,255,0.78);
    }

    body{ font-family:system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .container{ max-width:1040px; margin:0 auto; padding:16px 20px 90px; }

    /* Header */
    .header{
      background:var(--glass); border:1px solid var(--border); border-radius:var(--radius);
      padding:16px; margin-bottom:16px; backdrop-filter:blur(10px);
    }
    .header-top{ display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }
    .logo{ display:flex; align-items:center; gap:12px; }
    .logo svg{ width:60px; height:34px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Banner de Notifica√ß√£o (no cabe√ßalho) */
    .header-notify{
      margin-top:12px;
      border:1px solid rgba(56,189,248,0.35);
      background:rgba(56,189,248,0.10);
      border-radius:14px;
      padding:12px 12px;
      display:none;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .header-notify.show{ display:flex; }
    .header-notify .left{ display:flex; gap:10px; align-items:flex-start; }
    .header-notify .icon{
      width:34px; height:34px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(56,189,248,0.18);
      flex:0 0 auto;
    }
    .header-notify .title{ font-weight:800; font-size:13px; margin-bottom:2px; }
    .header-notify .msg{ font-size:13px; color:var(--text); line-height:1.35; }
    .header-notify .meta{ font-size:11px; color:var(--text-light); margin-top:4px; }
    .header-notify .close{
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      white-space:nowrap;
    }
    .header-notify .close:hover{ background:rgba(56,189,248,0.18); border-color:rgba(56,189,248,0.35); }
    .header-notify.success{ border-color:rgba(34,197,94,0.40); background:rgba(34,197,94,0.12); }
    .header-notify.success .icon{ background:rgba(34,197,94,0.20); }
    .header-notify.warning{ border-color:rgba(245,158,11,0.45); background:rgba(245,158,11,0.12); }
    .header-notify.warning .icon{ background:rgba(245,158,11,0.22); }
    .header-notify.danger{ border-color:rgba(239,68,68,0.45); background:rgba(239,68,68,0.10); }
    .header-notify.danger .icon{ background:rgba(239,68,68,0.18); }

    /* Bot√µes / chips */
    .btn{
      padding:8px 16px; border:1px solid var(--border); background:var(--glass); color:var(--text);
      border-radius:999px; font-size:13px; font-weight:600; cursor:pointer; transition:0.2s;
      display:inline-flex; align-items:center; gap:6px;
    }
    .btn:hover{ background:var(--accent); color:white; }
    .btn-success{ background:var(--success); color:white; border:none; }
    .btn-success:hover{ background:#16a34a; }
    .btn-warning{ background:var(--warning); color:white; border:none; }
    .btn-warning:hover{ background:#ea580c; }

    .chip{
      padding:6px 12px;
      background:rgba(56,189,248,0.10);
      border:1px solid rgba(56,189,248,0.30);
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ background:var(--accent); color:#fff; border-color:var(--accent); }

    /* Banner Hoje */
    .banner{
      background:rgba(56,189,248,0.10);
      border:1px solid var(--accent);
      border-radius:var(--radius);
      padding:16px;
      margin-bottom:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }
    .banner-info h2{ font-size:16px; margin-bottom:4px; }
    .banner-info p{ color:var(--text-light); font-size:13px; }
    .banner-stats{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Filtros */
    .filters{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
    .search-box{
      flex:1; min-width:250px;
      display:flex; align-items:center; gap:8px;
      padding:8px 12px;
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:999px;
    }
    .search-box input{ flex:1; background:none; border:none; color:var(--text); font-size:13px; outline:none; }
    .filter-group{
      display:flex; gap:8px; flex-wrap:wrap; padding:8px;
      background:var(--glass); border:1px solid var(--border);
      border-radius:999px;
    }
    .filter-btn{
      padding:6px 12px; border:none; background:transparent;
      color:var(--text-light); border-radius:999px; font-size:12px; cursor:pointer;
    }
    .filter-btn.active{ background:var(--accent); color:white; }
    .filter-btn.location{ border:1px solid var(--border); }
    .filter-btn.location.active{ background:var(--accent); color:white; border-color:var(--accent); }
    .filter-btn.clear{ color:#ef4444; border-color:#ef4444; }
    .filter-btn.clear:hover{ background:#ef4444; color:white; }
    .result-count{ font-size:12px; color:var(--text-light); margin-left:8px; }

    /* Cards */
    .day-card{ border:1px solid var(--border); border-radius:var(--radius); background:var(--glass); margin:16px 0; overflow:hidden; }
    .day-card.today{ border-color:var(--accent); box-shadow:0 0 20px rgba(56,189,248,0.20); }
    .day-header{ padding:16px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .day-name{ font-weight:800; font-size:15px; }
    .day-badge{ padding:4px 12px; background:var(--glass); border:1px solid var(--border); border-radius:999px; font-size:11px; }
    .day-badge.today{ background:var(--accent); color:white; border-color:var(--accent); }
    .events{ padding:16px; }
    .event{
      padding:16px; border:1px solid var(--border); border-radius:12px; margin-bottom:12px;
      background:rgba(0,0,0,0.20);
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
    }
    .event-title{ font-weight:700; font-size:14px; margin-bottom:6px; }
    .event-place{ color:var(--text-light); font-size:12px; }
    .event-tag{ display:inline-block; padding:2px 8px; background:rgba(56,189,248,0.20); border-radius:999px; font-size:10px; margin-left:6px; }
    .event-time{ padding:8px 16px; background:rgba(56,189,248,0.10); border:1px solid rgba(56,189,248,0.30); border-radius:999px; font-size:12px; font-weight:700; white-space:nowrap; }

    /* Festas */
    .festas-section{ background:var(--glass); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-top:24px; }
    .festas-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:10px; }
    .festas-header h3{ display:flex; align-items:center; gap:8px; }

    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th{ text-align:left; padding:12px; background:rgba(0,0,0,0.30); color:var(--text-light); }
    td{ padding:12px; border-bottom:1px solid var(--border); }
    .action-btn{ padding:6px 12px; border:1px solid var(--border); background:transparent; border-radius:6px; cursor:pointer; margin:0 4px; }
    .action-btn:hover{ background:var(--accent); color:white; }

    /* Modal */
    .modal{
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.80);
      display:flex; align-items:center; justify-content:center;
      z-index:1000;
    }
    .modal-content{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:24px;
      max-width:520px;
      width:90%;
      max-height:80vh;
      overflow-y:auto;
    }
    .modal-content input,.modal-content select,.modal-content textarea{
      width:100%; padding:12px; margin:8px 0;
      border:1px solid var(--border);
      border-radius:8px;
      background:var(--glass);
      color:var(--text);
    }
    .modal-content textarea{ min-height:160px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .modal-actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:20px; flex-wrap:wrap; }

    .toast{
      position:fixed; bottom:90px; left:50%;
      transform:translateX(-50%);
      background:var(--card);
      border-left:4px solid var(--success);
      padding:16px 24px;
      border-radius:8px;
      display:none;
      z-index:1000;
      font-weight:800;
    }

    /* FAB */
    .fab{
      position:fixed; right:20px; bottom:20px;
      background:var(--accent); color:white;
      border:none; border-radius:999px;
      padding:12px 24px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(56,189,248,0.30);
      z-index:100;
    }
    .fab:hover{ transform:translateY(-4px); }

    @media (max-width:768px){
      .fab span{ display:none; }
      .fab{ padding:12px; border-radius:50%; }
      .filters{ flex-direction:column; }
      .header-notify{ align-items:flex-start; }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-top">
        <div class="logo">
          <svg viewBox="0 0 240 140" width="60" height="34">
            <rect x="0" y="0" width="240" height="140" rx="18" fill="#ffffff"/>
            <path d="M120 18c27 0 50 17 58 40-9-6-20-10-33-10-18 0-34 8-44 20-10-12-26-20-44-20-13 0-24 4-33 10 8-23 31-40 58-40z" fill="#0f172a" opacity="0.92"/>
            <path d="M47 78c10-10 24-16 40-16 14 0 26 5 35 13 9-8 21-13 35-13 16 0 30 6 40 16-14 26-39 44-75 44S61 104 47 78z" fill="#0ea5e9" opacity="0.92"/>
            <text x="120" y="96" text-anchor="middle" font-family="Arial" font-size="34" font-weight="900" fill="#0f172a">CCB</text>
          </svg>
          <div>
            <h2>Agenda CCB</h2>
            <small>Amambai - MS</small>
          </div>
        </div>

        <div class="actions">
          <span class="chip" id="themeBtn" onclick="toggleTheme()">üåì Tema</span>
          <span class="chip" id="adminBtn" onclick="mostrarLogin()">üîê Admin</span>
          <span class="chip" id="notifyAdminBtn" onclick="mostrarModalAviso()" style="display:none">üì£ Enviar Aviso</span>
          <span class="chip" id="logoutBtn" onclick="logoutAdmin()" style="display:none">üö™ Sair</span>
        </div>
      </div>

      <!-- Banner de Notifica√ß√£o no cabe√ßalho (aparece para todos quando admin publica) -->
      <div class="header-notify" id="headerNotify" aria-live="polite">
        <div class="left">
          <div class="icon" id="headerNotifyIcon">üì£</div>
          <div>
            <div class="title" id="headerNotifyTitle">Aviso</div>
            <div class="msg" id="headerNotifyMsg"></div>
            <div class="meta" id="headerNotifyMeta"></div>
          </div>
        </div>
        <button class="close" onclick="fecharBannerAviso()">‚úï Fechar</button>
      </div>
    </div>

    <!-- Banner Hoje -->
    <div class="banner" id="banner">
      <div class="banner-info">
        <h2 id="bannerTitle">Carregando...</h2>
        <p id="bannerSubtitle"></p>
      </div>
      <div class="banner-stats">
        <span class="chip" id="clock">--:--</span>
        <span class="chip" id="weekInfo">Semana: --</span>
        <span class="chip" id="nextEvent">Falta: --</span>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <div class="search-box">
        <span>üîç</span>
        <input type="search" id="search" placeholder="Buscar cultos..." oninput="aplicarFiltros()">
      </div>

      <div class="filter-group">
        <button class="filter-btn" onclick="setFilter('today')" id="filterToday">üìÖ Hoje</button>
        <button class="filter-btn" onclick="setFilter('week')" id="filterWeek">üìÜ Semana</button>
        <button class="filter-btn active" onclick="setFilter('all')" id="filterAll">üìã Todos</button>
      </div>

      <div class="filter-group">
        <button class="filter-btn location active" onclick="filtrarLocal('todos')" id="localTodos">üåç Todos</button>
        <button class="filter-btn location" onclick="filtrarLocal('Central')">üèõÔ∏è Central</button>
        <button class="filter-btn location" onclick="filtrarLocal('Vila Limeira')">üèòÔ∏è Limeira</button>
        <button class="filter-btn location" onclick="filtrarLocal('Vila Gl√≥ria')">üèòÔ∏è Gl√≥ria</button>
        <button class="filter-btn location" onclick="filtrarLocal('Vila Cristina')">üèòÔ∏è Cristina</button>
        <button class="filter-btn location" onclick="filtrarLocal('Aldeia')">‚õ™ Aldeias</button>
        <button class="filter-btn location clear" onclick="limparLocal()">‚úï</button>
        <span class="result-count" id="resultCount"></span>
      </div>
    </div>

    <!-- Cultos -->
    <div id="cultos-container"></div>

    <!-- Festas -->
    <div class="festas-section">
      <div class="festas-header">
        <h3><span>‚≠ê</span>Festas Espirituais</h3>
        <button class="btn btn-success" id="novaFestaBtn" onclick="mostrarModalFesta()" style="display:none">+ Nova</button>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Hora</th>
              <th>Festa</th>
              <th>Local</th>
              <th>Pregador</th>
              <th id="acoesHeader" style="display:none">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="festas-list"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" onclick="irParaHoje()">üìå <span>HOJE</span></button>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Modal Login -->
  <div id="loginModal" class="modal" style="display:none">
    <div class="modal-content">
      <h3>üîê Acesso Admin</h3>
      <input type="password" id="senhaInput" placeholder="Digite a senha">
      <div class="modal-actions">
        <button class="btn" onclick="fecharModal('login')">Cancelar</button>
        <button class="btn btn-success" onclick="fazerLogin()">Entrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Aviso (Admin) -->
  <div id="avisoModal" class="modal" style="display:none">
    <div class="modal-content">
      <h3>üì£ Controle de Notifica√ß√µes</h3>

      <label style="font-size:12px; color:var(--text-light); font-weight:700;">Tipo do aviso</label>
      <select id="avisoTipo">
        <option value="info">‚ÑπÔ∏è Informativo</option>
        <option value="success">‚úÖ Importante</option>
        <option value="warning">‚ö†Ô∏è Aten√ß√£o</option>
        <option value="danger">‚õî Urgente</option>
      </select>

      <label style="font-size:12px; color:var(--text-light); font-weight:700;">T√≠tulo (opcional)</label>
      <input type="text" id="avisoTitulo" placeholder="Ex.: Mudan√ßa de hor√°rio hoje">

      <label style="font-size:12px; color:var(--text-light); font-weight:700;">Mensagem</label>
      <textarea id="avisoMensagem" placeholder="Digite a mensagem que aparecer√° para todos..."></textarea>

      <label style="display:flex; gap:8px; align-items:center; margin-top:10px; cursor:pointer;">
        <input type="checkbox" id="avisoNotificarOneSignal" checked>
        <span style="font-size:13px; color:var(--text-light);">üì± Enviar como notifica√ß√£o push (OneSignal)</span>
      </label>

      <div class="modal-actions">
        <button class="btn" onclick="fecharModal('aviso')">Cancelar</button>
        <button class="btn btn-warning" onclick="limparAviso()">üßπ Remover aviso</button>
        <button class="btn btn-success" onclick="salvarAviso()">üì¢ Publicar</button>
      </div>
    </div>
  </div>

  <!-- Modal Festa -->
  <div id="festaModal" class="modal" style="display:none">
    <div class="modal-content">
      <h3 id="modalTitle">Nova Festa</h3>
      <select id="festaTipo">
        <option value="culto-mocidade">Culto Mocidade</option>
        <option value="reuniao-mocidade">Reuni√£o Mocidade</option>
        <option value="batismo">Batismo</option>
        <option value="santa-ceia">Santa Ceia</option>
        <option value="ensaio-regional">Ensaio Regional</option>
        <option value="outro">Outro</option>
      </select>
      <input type="text" id="festaTitulo" placeholder="T√≠tulo (se outro)">
      <input type="date" id="festaData">
      <input type="time" id="festaHora" value="19:30">
      <input type="text" id="festaLocal" placeholder="Local">
      <input type="text" id="festaIrmao" placeholder="Pregador">
      <div class="modal-actions">
        <button class="btn" onclick="fecharModal('festa')">Cancelar</button>
        <button class="btn btn-success" onclick="salvarFesta()">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    // Dados dos cultos
    const cultos = [
      // Domingo
      { id: 'dom1', dia: 0, hora: '09:30', titulo: 'Reuni√£o de Jovens e Menores', local: 'Central Amambai', regra: 'all' },
      { id: 'dom2', dia: 0, hora: '09:30', titulo: 'Reuni√£o de Jovens e Menores', local: 'Vila Cristina', regra: 'all' },
      { id: 'dom3', dia: 0, hora: '15:00', titulo: 'Culto Oficial', local: 'Aldeia Amambai Central', regra: 'all' },
      { id: 'dom4', dia: 0, hora: '15:00', titulo: 'Culto com Recitativo', local: 'Aldeia Amambai Central', regra: 'nth:1,3' },
      { id: 'dom5', dia: 0, hora: '15:00', titulo: 'Culto com Recitativos', local: 'Aldeia Amambai Central', regra: 'all' },
      { id: 'dom6', dia: 0, hora: '15:00', titulo: 'Culto com Ensaio', local: 'Aldeia Amambai Central', regra: 'nth:4' },
      { id: 'dom7', dia: 0, hora: '19:00', titulo: 'Culto com Recitativos', local: 'Vila Gl√≥ria', regra: 'all' },
      { id: 'dom8', dia: 0, hora: '19:00', titulo: 'Culto Oficial', local: 'Central Amambai', regra: 'all' },
      { id: 'dom9', dia: 0, hora: '19:00', titulo: 'Culto Oficial', local: 'Vila Cristina', regra: 'all' },

      // Segunda
      { id: 'seg1', dia: 1, hora: '19:30', titulo: 'Culto com Recitativos', local: 'Vila Limeira', regra: 'all' },

      // Ter√ßa
      { id: 'ter1', dia: 2, hora: '19:30', titulo: 'Culto Oficial', local: 'Vila Gl√≥ria', regra: 'all' },

      // Quarta
      { id: 'qua1', dia: 3, hora: '19:30', titulo: 'Culto Oficial', local: 'Central Amambai', regra: 'all' },

      // Quinta
      { id: 'qui1', dia: 4, hora: '19:30', titulo: 'Culto Oficial', local: 'Vila Limeira', regra: 'all' },
      { id: 'qui2', dia: 4, hora: '19:30', titulo: 'Culto com Ensaio', local: 'Vila Limeira', regra: 'nth:2' },
      { id: 'qui3', dia: 4, hora: '19:30', titulo: 'Culto Oficial', local: 'Aldeia Sert√£ozinho', regra: 'all' },
      { id: 'qui4', dia: 4, hora: '19:30', titulo: 'Culto com Recitativos', local: 'Aldeia Sert√£ozinho', regra: 'nth:3' },

      // Sexta
      { id: 'sex1', dia: 5, hora: '19:30', titulo: 'Ensaio Local', local: 'Central Amambai', regra: 'nth:1' },
      { id: 'sex2', dia: 5, hora: '19:30', titulo: 'Ensaio Local', local: 'Vila Cristina', regra: 'nth:3' },
      { id: 'sex3', dia: 5, hora: '19:30', titulo: 'Ensaio Local', local: 'Vila Gl√≥ria', regra: 'nth:4' },

      // S√°bado
      { id: 'sab1', dia: 6, hora: '09:00', titulo: 'Evangeliza√ß√£o', local: 'Pres√≠dio', regra: 'all' },
      { id: 'sab2', dia: 6, hora: '15:00', titulo: 'Evangeliza√ß√£o', local: 'Lar do Idoso', regra: 'nth:2,4' },
      { id: 'sab3', dia: 6, hora: '16:00', titulo: 'Culto Oficial', local: 'Aldeia Lim√£o Verde', regra: 'all' },
      { id: 'sab4', dia: 6, hora: '18:30', titulo: 'Culto com Recitativos', local: 'Aldeia Invernada I', regra: 'nth:2' },
      { id: 'sab5', dia: 6, hora: '19:30', titulo: 'Culto Oficial', local: 'Central Amambai', regra: 'all' }
    ];

    let festas = [];
    let isAdmin = false;
    let filtros = { busca: '', local: 'todos', periodo: 'all' };

    const dias = ['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
    const ADMIN_SENHA = "ccb2025";
    const FESTAS_KEY = 'ccb_festas';

    // Avisos (banner no cabe√ßalho)
    const AVISO_KEY = 'ccb_aviso_header';
    const AVISO_HIDE_KEY = 'ccb_aviso_header_hidden';

    // OneSignal
    window.OneSignalDeferred = window.OneSignalDeferred || [];

    function init(){
      const savedTheme = localStorage.getItem('ccb_theme');
      if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);

      carregarFestas();
      carregarAvisoHeader();

      aplicarFiltros();
      atualizarRelogio();
      setInterval(atualizarRelogio, 60000);
    }

    // ===== AVISO NO CABE√áALHO =====
    function carregarAvisoHeader(){
      const hidden = localStorage.getItem(AVISO_HIDE_KEY) === '1';
      const saved = localStorage.getItem(AVISO_KEY);
      if (!saved || hidden) {
        esconderAvisoUI();
        return;
      }
      try {
        const aviso = JSON.parse(saved);
        exibirAvisoUI(aviso);
      } catch {
        esconderAvisoUI();
      }
    }

    function exibirAvisoUI(aviso){
      const box = document.getElementById('headerNotify');
      const titleEl = document.getElementById('headerNotifyTitle');
      const msgEl = document.getElementById('headerNotifyMsg');
      const metaEl = document.getElementById('headerNotifyMeta');
      const iconEl = document.getElementById('headerNotifyIcon');

      box.classList.remove('info','success','warning','danger');
      const tipo = (aviso.tipo || 'info').toLowerCase();
      if (['success','warning','danger','info'].includes(tipo)) box.classList.add(tipo);

      const icons = { info:'üì£', success:'‚úÖ', warning:'‚ö†Ô∏è', danger:'‚õî' };
      iconEl.textContent = icons[tipo] || 'üì£';

      titleEl.textContent = (aviso.titulo && aviso.titulo.trim()) ? aviso.titulo.trim() : 'Aviso';
      msgEl.textContent = aviso.mensagem || '';
      if (aviso.quando) {
        const d = new Date(aviso.quando);
        metaEl.textContent = `Publicado em ${d.toLocaleString()}`;
      } else {
        metaEl.textContent = '';
      }

      if (!aviso.mensagem || !aviso.mensagem.trim()) {
        esconderAvisoUI();
        return;
      }
      box.classList.add('show');
    }

    function esconderAvisoUI(){
      const box = document.getElementById('headerNotify');
      box.classList.remove('show','info','success','warning','danger');
      document.getElementById('headerNotifyMsg').textContent = '';
      document.getElementById('headerNotifyMeta').textContent = '';
    }

    function fecharBannerAviso(){
      localStorage.setItem(AVISO_HIDE_KEY, '1');
      esconderAvisoUI();
      toast('üîï Aviso fechado');
    }

    function mostrarModalAviso(){
      if (!isAdmin) return;
      localStorage.removeItem(AVISO_HIDE_KEY);

      const saved = localStorage.getItem(AVISO_KEY);
      let aviso = { tipo:'info', titulo:'', mensagem:'' };
      if (saved) {
        try { aviso = { ...aviso, ...JSON.parse(saved) }; } catch {}
      }

      document.getElementById('avisoTipo').value = aviso.tipo || 'info';
      document.getElementById('avisoTitulo').value = aviso.titulo || '';
      document.getElementById('avisoMensagem').value = aviso.mensagem || '';
      document.getElementById('avisoNotificarOneSignal').checked = true;

      document.getElementById('avisoModal').style.display = 'flex';
    }

    function salvarAviso(){
      if (!isAdmin) return;

      const tipo = document.getElementById('avisoTipo').value;
      const titulo = document.getElementById('avisoTitulo').value || '';
      const mensagem = document.getElementById('avisoMensagem').value || '';

      if (!mensagem.trim()){
        alert('Digite uma mensagem para o aviso.');
        return;
      }

      const aviso = { tipo, titulo, mensagem, quando: new Date().toISOString() };
      localStorage.setItem(AVISO_KEY, JSON.stringify(aviso));
      localStorage.removeItem(AVISO_HIDE_KEY);
      exibirAvisoUI(aviso);
      
      // Enviar notifica√ß√£o OneSignal se marcado
      const enviarOneSignal = document.getElementById('avisoNotificarOneSignal').checked;
      if (enviarOneSignal) {
        window.OneSignalDeferred.push(function(OneSignal) {
          OneSignal.Notifications.createNotification({
            headings: { en: titulo || 'Aviso', pt: titulo || 'Aviso' },
            contents: { en: mensagem, pt: mensagem },
          });
        });
      }

      fecharModal('aviso');
      toast('üì£ Aviso publicado' + (enviarOneSignal ? ' com notifica√ß√£o' : ''));
    }

    function limparAviso(){
      if (!isAdmin) return;
      if (!confirm('Remover o aviso do cabe√ßalho?')) return;
      localStorage.removeItem(AVISO_KEY);
      localStorage.removeItem(AVISO_HIDE_KEY);
      esconderAvisoUI();
      fecharModal('aviso');
      toast('üßπ Aviso removido');
    }

    // ===== FUN√á√ïES EXISTENTES =====
    function getSemana(){
      const hoje = new Date();
      const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
      return Math.ceil((hoje.getDate() + primeiroDia.getDay()) / 7);
    }

    function filtrarCultos(){
      const semana = getSemana();

      return cultos.filter(c => {
        if (filtros.busca && !`${c.titulo} ${c.local}`.toLowerCase().includes(filtros.busca)) return false;

        if (filtros.local !== 'todos') {
          if (filtros.local === 'Aldeia' && !c.local.includes('Aldeia')) return false;
          if (filtros.local !== 'Aldeia' && !c.local.includes(filtros.local)) return false;
        }

        if (filtros.periodo === 'today' && c.dia !== new Date().getDay()) return false;

        if (filtros.periodo === 'week') return true;

        if (c.regra !== 'all') {
          const semanas = c.regra.replace('nth:', '').split(',').map(Number);
          return semanas.includes(semana);
        }
        return true;
      });
    }

    function renderizarCultos(){
      const cultosFiltrados = filtrarCultos();
      const container = document.getElementById('cultos-container');

      let html = '';
      for (let d = 0; d < 7; d++) {
        const cultosDia = cultosFiltrados.filter(c => c.dia === d).sort((a,b) => a.hora.localeCompare(b.hora));
        if (cultosDia.length === 0 && filtros.periodo !== 'week') continue;

        const isHoje = d === new Date().getDay();
        html += `
          <div class="day-card ${isHoje ? 'today' : ''}" id="dia-${d}">
            <div class="day-header">
              <span class="day-name">${dias[d]}</span>
              <span class="day-badge ${isHoje ? 'today' : ''}">${isHoje ? 'Hoje' : 'Agenda'}</span>
            </div>
            <div class="events">
              ${cultosDia.map(c => {
                const tag = c.regra !== 'all'
                  ? `<span class="event-tag">${c.regra.replace('nth:', '').replace(',', ' e ')}¬™</span>`
                  : '';
                return `
                  <div class="event">
                    <div>
                      <div class="event-title">${c.titulo} ${tag}</div>
                      <div class="event-place">üìç ${c.local}</div>
                    </div>
                    <div class="event-time">${c.hora}</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      container.innerHTML = html || '<div style="text-align:center;padding:40px">Nenhum culto encontrado</div>';
      document.getElementById('resultCount').textContent = `${cultosFiltrados.length} cultos`;
      atualizarBanner();
    }

    function carregarFestas(){
      const saved = localStorage.getItem(FESTAS_KEY);
      festas = saved ? JSON.parse(saved) : [
        { id: 1, titulo: 'Culto Mocidade', data: '2026-02-26', hora: '19:30', local: 'Aldeia Sert√£ozinho', irmao: 'Jo√£o Butarelli' },
        { id: 2, titulo: 'Santa Ceia', data: '2026-03-15', hora: '19:30', local: 'Central Amambai', irmao: 'Mois√©s Crepaldi' }
      ];
      renderizarFestas();
    }

    function renderizarFestas(){
      const hoje = new Date().toISOString().split('T')[0];
      const futuras = festas.filter(f => f.data >= hoje).sort((a,b) => a.data.localeCompare(b.data));

      document.getElementById('festas-list').innerHTML = futuras.map(f => `
        <tr>
          <td>${new Date(f.data).toLocaleDateString()}</td>
          <td>${f.hora}</td>
          <td>${f.titulo}</td>
          <td>${f.local}</td>
          <td>Ir. ${f.irmao}</td>
          ${isAdmin ? `<td>
            <button class="action-btn" onclick="editarFesta(${f.id})">‚úèÔ∏è</button>
            <button class="action-btn" onclick="excluirFesta(${f.id})">üóëÔ∏è</button>
          </td>` : ''}
        </tr>
      `).join('');
    }

    function atualizarBanner(){
      const agora = new Date();
      const dia = agora.getDay();
      const horaAtual = agora.getHours() * 60 + agora.getMinutes();
      const semana = getSemana();

      document.getElementById('clock').textContent = agora.toLocaleTimeString().slice(0,5);
      document.getElementById('weekInfo').textContent = `Semana: ${semana}¬™ (${dias[dia]})`;
      document.getElementById('bannerTitle').textContent = `HOJE ‚Äî ${dias[dia]}`;

      const eventosHoje = cultos.filter(c => c.dia === dia).filter(c => {
        if (c.regra === 'all') return true;
        const semanas = c.regra.replace('nth:', '').split(',').map(Number);
        return semanas.includes(semana);
      });

      if (eventosHoje.length === 0) {
        document.getElementById('bannerSubtitle').textContent = 'Nenhum evento hoje';
        return;
      }

      document.getElementById('bannerSubtitle').innerHTML = eventosHoje.map(e =>
        `${e.hora} - ${e.titulo} (${e.local})`
      ).join('<br>');

      const proximo = eventosHoje.find(e => {
        const [h, m] = e.hora.split(':').map(Number);
        return h * 60 + m > horaAtual;
      });

      if (proximo) {
        const [h, m] = proximo.hora.split(':').map(Number);
        const diff = (h * 60 + m) - horaAtual;
        document.getElementById('nextEvent').textContent = `Falta: ${Math.floor(diff/60)}h${diff%60}min`;
      } else {
        document.getElementById('nextEvent').textContent = `Falta: --`;
      }
    }

    function atualizarRelogio(){ atualizarBanner(); }

    function setFilter(tipo){
      filtros.periodo = tipo;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`filter${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).classList.add('active');
      renderizarCultos();
    }

    function filtrarLocal(local){
      filtros.local = local;
      document.querySelectorAll('.location').forEach(b => b.classList.remove('active'));
      if (window.event && window.event.target) window.event.target.classList.add('active');
      renderizarCultos();
    }

    function limparLocal(){
      filtros.local = 'todos';
      document.querySelectorAll('.location').forEach(b => b.classList.remove('active'));
      document.getElementById('localTodos').classList.add('active');
      renderizarCultos();
    }

    function aplicarFiltros(){
      filtros.busca = document.getElementById('search').value.toLowerCase();
      renderizarCultos();
    }

    function irParaHoje(){
      const el = document.getElementById(`dia-${new Date().getDay()}`);
      if (el) el.scrollIntoView({ behavior:'smooth' });
    }

    function mostrarLogin(){
      document.getElementById('loginModal').style.display = 'flex';
    }

    function fecharModal(tipo){
      if (tipo === 'login') document.getElementById('loginModal').style.display = 'none';
      if (tipo === 'aviso') document.getElementById('avisoModal').style.display = 'none';
      if (tipo === 'festa') document.getElementById('festaModal').style.display = 'none';
    }

    function fazerLogin(){
      if (document.getElementById('senhaInput').value === ADMIN_SENHA) {
        isAdmin = true;
        document.getElementById('adminBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'inline-block';
        document.getElementById('notifyAdminBtn').style.display = 'inline-block';
        document.getElementById('novaFestaBtn').style.display = 'inline-block';
        document.getElementById('acoesHeader').style.display = 'table-cell';
        fecharModal('login');
        renderizarFestas();
        toast('‚úÖ Modo admin ativado');
      } else {
        alert('Senha incorreta!');
      }
    }

    function logoutAdmin(){
      isAdmin = false;
      document.getElementById('adminBtn').style.display = 'inline-block';
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('notifyAdminBtn').style.display = 'none';
      document.getElementById('novaFestaBtn').style.display = 'none';
      document.getElementById('acoesHeader').style.display = 'none';
      renderizarFestas();
      toast('üîì Modo admin desativado');
    }

    function mostrarModalFesta(){
      if (!isAdmin) return;
      document.getElementById('modalTitle').textContent = 'Nova Festa';
      document.getElementById('festaTipo').value = 'culto-mocidade';
      document.getElementById('festaTitulo').value = '';

      const hoje = new Date();
      hoje.setDate(hoje.getDate() + 7);
      document.getElementById('festaData').value = hoje.toISOString().split('T')[0];
      document.getElementById('festaHora').value = '19:30';
      document.getElementById('festaLocal').value = '';
      document.getElementById('festaIrmao').value = '';

      document.getElementById('festaModal').style.display = 'flex';
    }

    function salvarFesta(){
      const tipo = document.getElementById('festaTipo').value;
      let titulo = document.getElementById('festaTitulo').value;
      const data = document.getElementById('festaData').value;
      const hora = document.getElementById('festaHora').value;
      const local = document.getElementById('festaLocal').value;
      const irmao = document.getElementById('festaIrmao').value;

      if (!data || !hora || !local || !irmao) { alert('Preencha todos os campos!'); return; }
      if (tipo === 'outro' && !titulo) { alert('Digite o t√≠tulo da festa!'); return; }

      const titulos = {
        'culto-mocidade': 'Culto para Mocidade',
        'reuniao-mocidade': 'Reuni√£o para Mocidade',
        'batismo': 'Batismo',
        'santa-ceia': 'Santa Ceia',
        'ensaio-regional': 'Ensaio Regional'
      };

      const novaFesta = { id: Date.now(), titulo: titulos[tipo] || titulo, data, hora, local, irmao };
      festas.push(novaFesta);
      localStorage.setItem(FESTAS_KEY, JSON.stringify(festas));
      renderizarFestas();
      fecharModal('festa');
      toast('‚úÖ Festa adicionada');
    }

    function editarFesta(id){ toast('‚úèÔ∏è Editar festa'); }

    function excluirFesta(id){
      if (confirm('Excluir festa?')) {
        festas = festas.filter(f => f.id !== id);
        localStorage.setItem(FESTAS_KEY, JSON.stringify(festas));
        renderizarFestas();
        toast('‚úÖ Festa exclu√≠da');
      }
    }

    function toggleTheme(){
      const atual = document.documentElement.getAttribute('data-theme') || 'dark';
      const novo = atual === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', novo);
      localStorage.setItem('ccb_theme', novo);
    }

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    }

    init();
  </script>
</body>
</html>
